<!--
title: Утилита rcync
description: синхронизация директорий и backup-ы
published: true
date: 2025-01-01T19:54:41.369Z
tags: linux, copy, server, настройка, конфигурирование, команда, сервер, rsync, backup, файл, директория
editor: ckeditor
dateCreated: 2025-01-01T19:54:41.369Z
-->

<p>Утилита <strong>rsync</strong> — это программное обеспечение с открытым исходным кодом, которое можно использовать для синхронизации файлов и директорий с локального компьютера на удаленный и наоборот. Примечательная особенность <strong>rsync</strong> — возможность передавать файлы с шифрованием, используя ssh в качестве транспорта.</p>
<p>Синтаксис команды:</p>
<pre><code class="language-plaintext">$ rsync опции источник приемник</code></pre>
<h2>Примеры использования</h2>
<p>Перед тем, как копировать файлы, всегда стоит сделать пробный прогон (ключ <code>-n</code>) в режиме с показом подробностей (<code>-v</code>):</p>
<pre><code class="language-plaintext">$ rsync -avn /path/to/src/ user@example.com:/path/to/dst</code></pre>
<p>В этом режиме <code>rsync</code> покажет список файлов, которые он скопирует. После этого можно запускать настоящее копирование:</p>
<pre><code class="language-plaintext">$ rsync -av /path/to/src/ user@example.com:/path/to/dst</code></pre>
<p>В этой команде ключ <code>-a</code> подразумевает рекурсивное копирование всех файлов и каталогов включая их атрибуты: владелец, группа, дата создания и изменения. Ключ <code>-v</code> даст подробный отчет о работе по мере выполнения и по окончании.</p>
<blockquote>
  <p>Обратите внимание на слэш в конце первого аргумента — без него файлы источника <code>/path/to/src/файлы</code> будут размещены в <code>/path/to/dst/src/файлы</code>. А при наличии слэша в конце первого аргумента — файлы будут в <code>/path/to/dst/файлы</code>, что скорее всего и нужно.</p>
</blockquote>
<p>По умолчанию <code>rsync</code> попытается использовать транспорт ssh. При использовании другого порта для ssh, его нужно указать:</p>
<pre><code class="language-plaintext">$ rsync -av -e "ssh -p 2222" /path/to/src/ user@example.com:/path/to/dst</code></pre>
<p>Точно также можно скопировать файлы из удаленного сервера на локальную машину:</p>
<pre><code class="language-plaintext">$ rsync -av user@example.com:/remote/machine/path/ /local/machine/path</code></pre>
<p>Обратите внимание, что источник всегда является первым аргументом, а приемник — вторым.</p>
<blockquote>
  <p>Для автоматического копирования, например по <code>cron</code>, необходимо настроить авторизацию с использованием ключей.</p>
</blockquote>
<h2>Основные опции</h2>
<p><strong>Опция</strong> <code>-a</code> или <code>--archive</code> — рекурсивно копирует файлы, включая разыменованные символьные ссылки, с сохранением связанных с файлами сведений об их владельцах, групповых и индивидуальных правах и времени последнего изменения. Использование этого ключа равносильно указанию ключей <code>--group</code>, <code>--links</code>, <code>--owner</code>, <code>--perms</code>, <code>--recursive</code> и <code>--times</code>.</p>
<p><strong>Опция</strong> <code>-b</code> или <code>--backup</code> — переименовывает файлы, которые в противном случае должны быть удалены или перезаписаны, добавляя к их существующим именам знак тильды (~). Эта опция обычно используется вместе с <code>--backup-dir</code> — вместо переименования <code>rsync</code> перемещает эти файлы в указанный каталог.</p>
<p><strong>Опция </strong><code>--backup-dir=dir</code> — используется вместе с <code>--backup</code> и перемещает в директорию <code>dir</code> те файлы, которые в противном случае должны быть удалены или перезаписаны. После перемещения старой версии файла в каталог <code>dir</code> новая версия из источника копируется в приемник.&nbsp;</p>
<blockquote>
  <p>Если <code>dir</code> указан с использованием относительного пути, то это путь относительно приемника.</p>
</blockquote>
<p><strong>Опция</strong> <code>--copy-unsafe-links</code> — для каждого файла, являющегося символьной ссылкой на файл за пределами той иерархии, которой принадлежит источник, производится копирование файла, на который указывает ссылка, а не символьной ссылки на него.</p>
<p><strong>Опция</strong> <code>--delete</code> заставляет <code>rsync</code> удалять файлы в приемнике, которые отсутствуют в источнике.</p>
<p><strong>Опция</strong> <code>-n</code> или <code>--dry-run</code> — запуск утилиты без записи на диск. С опцией <code>--verbose</code> позволяет посмотреть, что будет сделано, если запустить rsync без <code>--dry-run</code>. Особенно полезно запускать перед использованием <code>--delete</code>.</p>
<p><strong>Опция</strong> <code>-g</code> или <code>--group</code> — сохранение групповых связей копируемых файлов.</p>
<p><strong>Опция</strong> <code>-l</code> или <code>--links</code> — для каждого файла, являющегося символьной ссылкой, копирование символьной ссылки, а не файла, на который указывает ссылка, даже если файл, на который указывает ссылка, не присутствует в источнике.</p>
<p><strong>Опция</strong> <code>--link-dest=dir</code> — если файл существует в источнике, но его нет в приемнике, rsync ищет в каталоге <code>dir</code> файл с точно таким же именем. Если точная копия файла будет найдена, rsync создает из файла в <code>dir</code> жесткую ссылку на него в приемнике. Если точная копия не будет найдена, rsync копирует файл в приемник.</p>
<p><strong>Опция</strong> <code>-o</code> или <code>--owner</code> — сохранение данных о владельце копируемых файлов (только для пользователей с root-правами).</p>
<p><strong>Опция</strong> <code>-p</code> или <code>--perms</code> — сохранение данных о правах доступа копируемых файлов.</p>
<p><strong>Опция</strong> <code>-r</code> или <code>--recursive</code> — рекурсивный спуск по каталогу-источнику и копирование всех файлов в иерархии.</p>
<p><strong>Опция</strong> <code>-t</code> или <code>--times</code> — сохранение данных о времени последнего изменения копируемых файлов.</p>
<p><strong>Опция</strong> <code>-u</code> или <code>--update</code> — пропускать файл, если в приемнике оказался файл новее, чем в источнике.</p>
<p><strong>Опция</strong> <code>-v</code> или <code>--verbose</code> — вывод информации о том, что в данный момент делает rsync.</p>
<p><strong>Опция</strong> <code>-z</code> или <code>--compress</code> — сжатие файлов в процессе копирования.</p>
<h2>Зеркальное копирование</h2>
<p>Утилиту rsync можно использовать для создания зеркальной копии каталога. На удаленной системе должен быть установлен ssh-сервер (к нему можно подключиться с использованием утилиты ssh). Если нужно запускать копирование по расписанию, следует настроить авторизацию с использованием ключей.</p>
<pre><code class="language-plaintext">$ rsync --archive --update --delete /path/to/mirror/ user@example.com:/path/to/mirror</code></pre>
<p>Опция <code>--update</code> заставляет rsync не перезаписывать самые последние версии файлов на удаленной системе более старыми версиями таких же файлов, взятых из локальной системы. Опция <code>--delete</code> заставляет rsync удалять на удаленном сервере файлы, отсутствующие на локальной системе.</p>
<h2>Резервное копирование</h2>
<p>После проведения исходного резервного копирования rsync может эффективно осуществлять дополнительное резервное копирование, экономя место на диске и время копирования. При дополнительном (инкрементном) копировании сохраняются только те файлы, которые претерпели изменения со времени последнего резервного копирования.</p>
<p>С помощью опции <code>--link-dest=dir</code> можно превращать каждое дополняющее резервное копирование в полноценное, путем создания жестких ссылок между дополняющими резервными копиями и неизменившимися файлами, имеющимися в исходной полноценной резервной копии.</p>
<p>Если <code>dir</code> задается как отосительный путь, то он задается относительно файла-приемника.</p>
<pre><code class="language-plaintext">$ rsync --archive --link-dest=../backup /path/to/src/ user@example.com:/path/to/dst</code></pre>
<p>При запуске этой команды rsync проходит сверху вниз по содержимому каталога <code>/path/to/src</code>, проверяя каждый найденный файл. Для каждого файла в каталоге <code>/path/to/src</code> утилита ищет в каталоге <code>/path/to/dst</code> точную копию этого файла.</p>
<ul>
  <li>Если она находит точную копию в каталоге <code>/path/to/dst</code> — переходит к следующему файлу</li>
  <li>Если она не находит точную копию в каталоге <code>/path/to/dst</code> — ищет точную копию в каталоге <code>backup</code>
    <ul>
      <li>Если она находит точную копию файла в каталоге <code>backup</code>, утилита создает жесткую ссылку из файла в каталоге <code>backup</code> на файл в каталоге <code>/path/to/dst</code></li>
      <li>Если она не находит точную копию файла в каталоге <code>backup</code>, утилита копирует файл из каталога <code>/path/to/src</code> в каталог <code>/path/to/dst</code></li>
    </ul>
  </li>
</ul>
<p>Небольшой bash-скрипт, демонстрирующий создание полноценной и дополняющей резервной копии:</p>
<pre><code class="language-plaintext">#!/bin/bash
rm -rf backup-two-days-ago
mv backup-one-day-ago backup-two-days-ago
mv backup-latest-state backup-one-day-ago
rsync --archive --link-dest=../backup-one-day-ago /some/path/data/ backup-latest-state</code></pre>
<p>Можно немного доработать этот скрипт, чтобы хранить не три, а тридцать резервных копий:</p>
<pre><code class="language-plaintext">#!/bin/bash

SOURCE='/home/evgeniy/data'
BACKUP='/home/evgeniy/backup'
COUNT=30 # кол-во бэкапов

rm -rf ${BACKUP}/backup-${COUNT}
for (( i = COUNT; i &gt; 1; i-- )); do
    mv ${BACKUP}/backup-$((i - 1)) ${BACKUP}/backup-${i}
done

rsync --archive --link-dest=../backup-2 ${SOURCE}/ ${BACKUP}/backup-1</code></pre>
<p>&nbsp;</p>
<hr>
<p><span class="text-tiny">Оригинал </span><a href="https://tokmakov.msk.ru/blog/item/445"><span class="text-tiny">тут</span></a><span class="text-tiny">.</span></p>
